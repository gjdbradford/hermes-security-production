<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crisp Integration Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin: 20px 0;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 8px;
            font-size: 16px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-button.success {
            background: #28a745;
        }
        .test-button.error {
            background: #dc3545;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            font-size: 14px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
    </style>
</head>
<body>
    <h1>üß™ Crisp Integration Test Suite</h1>
    <p>This page tests the Crisp chat integration fixes implemented in v1.3.0</p>

    <div class="test-container">
        <h2>üìä Test Status</h2>
        <div id="status" class="status warning">Ready to test</div>
    </div>

    <div class="test-container">
        <h2>üîß Test Controls</h2>
        <button class="test-button" onclick="testCrispLoading()">Test Crisp Loading</button>
        <button class="test-button" onclick="testChatOpening()">Test Chat Opening</button>
        <button class="test-button" onclick="testSessionData()">Test Session Data</button>
        <button class="test-button" onclick="testErrorHandling()">Test Error Handling</button>
        <button class="test-button" onclick="testContactFormSimulation()">Simulate Contact Form</button>
        <button class="test-button" onclick="clearLogs()">Clear Logs</button>
    </div>

    <div class="test-container">
        <h2>üìù Test Logs</h2>
        <div id="logs" class="log">Click a test button to start testing...\n</div>
    </div>

    <!-- Crisp Chat Integration -->
    <script type="text/javascript">
        window.$crisp=[];
        window.CRISP_WEBSITE_ID="5aabd819-90ed-477c-9c40-0c98b2ec22dc";
        (function(){
            d=document;
            s=d.createElement("script");
            s.src="https://client.crisp.chat/l.js";
            s.async=1;
            d.getElementsByTagName("head")[0].appendChild(s);
        })();
    </script>

    <script>
        let testResults = {
            crispLoaded: false,
            chatOpened: false,
            sessionDataSet: false,
            errorHandling: false,
            contactFormSimulation: false
        };

        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            logs.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logs.scrollTop = logs.scrollHeight;
        }

        function updateStatus() {
            const status = document.getElementById('status');
            const passed = Object.values(testResults).filter(Boolean).length;
            const total = Object.keys(testResults).length;
            
            if (passed === total) {
                status.className = 'status success';
                status.textContent = `‚úÖ All tests passed (${passed}/${total})`;
            } else if (passed > 0) {
                status.className = 'status warning';
                status.textContent = `‚ö†Ô∏è Partial success (${passed}/${total})`;
            } else {
                status.className = 'status error';
                status.textContent = `‚ùå Tests failed (${passed}/${total})`;
            }
        }

        function clearLogs() {
            document.getElementById('logs').textContent = 'Logs cleared...\n';
        }

        // Test 1: Crisp Loading
        function testCrispLoading() {
            log('Testing Crisp loading...');
            
            setTimeout(() => {
                if (window.$crisp && typeof window.$crisp.push === 'function') {
                    testResults.crispLoaded = true;
                    log('Crisp loaded successfully', 'success');
                } else {
                    log('Crisp failed to load', 'error');
                }
                updateStatus();
            }, 2000);
        }

        // Test 2: Chat Opening
        function testChatOpening() {
            log('Testing chat opening...');
            
            if (window.$crisp) {
                try {
                    window.$crisp.push(['do', 'chat:open']);
                    testResults.chatOpened = true;
                    log('Chat opened successfully', 'success');
                } catch (error) {
                    log(`Chat opening failed: ${error.message}`, 'error');
                }
            } else {
                log('Crisp not available for chat opening', 'error');
            }
            updateStatus();
        }

        // Test 3: Session Data
        function testSessionData() {
            log('Testing session data setting...');
            
            if (window.$crisp) {
                try {
                    const testData = [
                        ['context', 'test_context'],
                        ['timestamp', new Date().toISOString().substring(0, 19)],
                        ['test_field', 'test_value']
                    ];
                    
                    window.$crisp.push(['set', 'session:data', testData]);
                    testResults.sessionDataSet = true;
                    log('Session data set successfully', 'success');
                } catch (error) {
                    log(`Session data setting failed: ${error.message}`, 'error');
                }
            } else {
                log('Crisp not available for session data', 'error');
            }
            updateStatus();
        }

        // Test 4: Error Handling
        function testErrorHandling() {
            log('Testing error handling...');
            
            // Add global error handler
            if (!window.crispErrorHandlerAdded) {
                window.addEventListener('unhandledrejection', (event) => {
                    if (event.reason && event.reason.message && event.reason.message.includes('Invalid data')) {
                        log('Caught and handled Crisp Invalid data error', 'warning');
                        event.preventDefault();
                    }
                });
                window.crispErrorHandlerAdded = true;
                testResults.errorHandling = true;
                log('Global error handler added successfully', 'success');
            } else {
                testResults.errorHandling = true;
                log('Global error handler already active', 'success');
            }
            updateStatus();
        }

        // Test 5: Contact Form Simulation
        function testContactFormSimulation() {
            log('Simulating contact form submission...');
            
            if (window.$crisp) {
                try {
                    // Simulate the contact form data
                    const formData = {
                        firstName: 'Test',
                        lastName: 'User',
                        email: 'test@example.com',
                        companyName: 'Test Company',
                        serviceUrgency: 'Urgent',
                        problemDescription: 'This is a test description with special characters: <>&"\''
                    };
                    
                    // Open chat
                    window.$crisp.push(['do', 'chat:open']);
                    
                    // Set session data with delay (like in our fixed implementation)
                    setTimeout(() => {
                        try {
                            const sessionData = [
                                ['context', 'contact_form_submission'],
                                ['timestamp', new Date().toISOString().substring(0, 19)],
                            ];
                            
                            window.$crisp.push(['set', 'session:data', sessionData]);
                            testResults.contactFormSimulation = true;
                            log('Contact form simulation completed successfully', 'success');
                        } catch (error) {
                            log(`Contact form simulation failed: ${error.message}`, 'error');
                        }
                        updateStatus();
                    }, 500);
                    
                } catch (error) {
                    log(`Contact form simulation failed: ${error.message}`, 'error');
                }
            } else {
                log('Crisp not available for contact form simulation', 'error');
            }
        }

        // Initialize
        window.addEventListener('load', () => {
            log('Test page loaded. Crisp integration test suite ready.');
            log('Click the test buttons above to run individual tests.');
            
            // Auto-test Crisp loading
            setTimeout(() => {
                testCrispLoading();
            }, 1000);
        });

        // Monitor for any unhandled errors
        window.addEventListener('error', (event) => {
            log(`Unhandled error: ${event.error?.message || event.message}`, 'error');
        });

        window.addEventListener('unhandledrejection', (event) => {
            log(`Unhandled promise rejection: ${event.reason}`, 'error');
        });
    </script>
</body>
</html>
