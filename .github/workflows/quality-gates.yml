name: Quality Gates & Deployment

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

# GitHub Pages permissions
permissions:
  contents: read
  pages: write
  id-token: write

# Environment variables
env:
  NODE_VERSION: '18'
  CACHE_VERSION: v1

# Quality Gates Configuration
jobs:
  # ========================================
  # QUALITY GATE 1: Code Quality & Linting
  # ========================================
  code-quality:
    name: ğŸ” Code Quality & Linting
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ” ESLint Check
        run: npm run lint
        continue-on-error: true

      - name: ğŸ¨ Prettier Check
        run: npx prettier --check "src/**/*.{ts,tsx,js,jsx,json,css,md}"
        continue-on-error: true

      - name: ğŸ“ TypeScript Type Check
        run: npx tsc --noEmit
        continue-on-error: false

      - name: ğŸ¯ CTA Master Rules Validation
        run: npm run validate:cta
        continue-on-error: false

      - name: ğŸ”’ Security Audit
        run: npm audit --audit-level=moderate
        continue-on-error: false

  # ========================================
  # QUALITY GATE 2: Build Validation
  # ========================================
  build-validation:
    name: ğŸ—ï¸ Build Validation
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: code-quality

    strategy:
      matrix:
        environment: [staging, production]

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build for ${{ matrix.environment }}
        run: |
          if [ "${{ matrix.environment }}" = "staging" ]; then
            npm run build:staging
          else
            npm run build:production
          fi
        continue-on-error: false

      - name: ğŸ“Š Build Size Check
        run: |
          echo "ğŸ“Š Build size analysis:"
          du -sh dist/
          echo "ğŸ“ Directory structure:"
          find dist/ -type f -name "*.js" -o -name "*.css" | head -10

      - name: ğŸ” Asset Validation
        run: |
          # Check critical files exist
          for file in index.html favicon.ico robots.txt sitemap.xml; do
            if [ -f "dist/$file" ]; then
              echo "âœ… $file found"
            else
              echo "âŒ $file missing"
              exit 1
            fi
          done

          # Check assets directory
          if [ -d "dist/assets" ]; then
            echo "âœ… Assets directory found"
            ls -la dist/assets/ | head -5
          else
            echo "âŒ Assets directory missing"
            exit 1
          fi
        continue-on-error: false

  # ========================================
  # QUALITY GATE 3: Testing & Validation
  # ========================================
  testing-validation:
    name: ğŸ§ª Testing & Validation
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: code-quality

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ§ª Run Routing Tests
        run: npm run test:routing
        continue-on-error: false

      - name: ğŸŒ Environment Tests
        run: npm run test:all-envs
        continue-on-error: false

      - name: ğŸ”§ CDN Integration Tests
        run: npm run test:cdn
        continue-on-error: false

      - name: ğŸ›¡ï¸ Security Tests
        run: npm run test:captcha
        continue-on-error: false

  # ========================================
  # QUALITY GATE 4: Security & Secrets
  # ========================================
  security-check:
    name: ğŸ›¡ï¸ Security & Secrets Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: code-quality

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Detect Secrets
        uses: Yelp/detect-secrets-action@master
        with:
          baseline: .secrets.baseline
          fail-on-any: true

      - name: ğŸ”’ Dependency Security Scan
        run: |
          npm audit --audit-level=high
        continue-on-error: false

      - name: ğŸ“‹ Security Report
        run: |
          echo "ğŸ›¡ï¸ Security check completed"
          echo "âœ… No secrets detected"
          echo "âœ… No high-severity vulnerabilities found"

  # ========================================
  # QUALITY GATE 5: Performance Check
  # ========================================
  performance-check:
    name: âš¡ Performance Check
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [build-validation, testing-validation]

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build for Performance Check
        run: npm run build:production

      - name: ğŸ“Š Bundle Size Analysis
        run: |
          echo "ğŸ“Š Bundle size analysis:"
          find dist/assets -name "*.js" -exec wc -c {} + | sort -n
          echo ""
          echo "ğŸ“ˆ Largest files:"
          find dist/assets -name "*.js" -exec ls -lh {} + | sort -k5 -hr | head -5

      - name: âš¡ Performance Budget Check
        run: |
          # Check if main bundle is under 500KB
          MAIN_BUNDLE_SIZE=$(find dist/assets -name "index-*.js" -exec wc -c {} + | awk '{sum+=$1} END {print sum}')
          if [ "$MAIN_BUNDLE_SIZE" -gt 512000 ]; then
            echo "âŒ Main bundle too large: ${MAIN_BUNDLE_SIZE} bytes (max: 512KB)"
            exit 1
          else
            echo "âœ… Main bundle size OK: ${MAIN_BUNDLE_SIZE} bytes"
          fi

  # ========================================
  # DEPLOYMENT: Staging (GitHub Pages)
  # ========================================
  deploy-staging:
    name: ğŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [code-quality, build-validation, testing-validation, security-check, performance-check]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    environment:
      name: staging
      url: https://gjdbradford.github.io/hermes-security-production/

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build for Staging
        run: npm run build:staging

      - name: ğŸš« Disable Jekyll
        run: |
          echo "# Static site - no Jekyll processing" > dist/.nojekyll
          echo "âœ… Jekyll disabled for GitHub Pages"

      - name: ğŸ“‹ Staging Deployment Summary
        run: |
          echo "ğŸš€ Staging Deployment Summary:"
          echo "ğŸ“ URL: https://gjdbradford.github.io/hermes-security-production/"
          echo "ğŸ“Š Build size: $(du -sh dist/ | cut -f1)"
          echo "ğŸ“ Files: $(find dist/ -type f | wc -l)"
          echo "âœ… Ready for deployment"

      - name: ğŸ“¦ Upload Staging Build Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist/

      - name: ğŸš€ Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
        with:
          artifact_name: staging-build

  # ========================================
  # DEPLOYMENT: Production (Vercel)
  # ========================================
  deploy-production:
    name: ğŸŒŸ Deploy to Production
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [deploy-staging]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    environment:
      name: production
      url: https://hermes-security-production.vercel.app/

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build for Production
        run: npm run build:production

      - name: ğŸ“‹ Production Deployment Summary
        run: |
          echo "ğŸŒŸ Production Deployment Summary:"
          echo "ğŸ“ URL: https://hermes-security-production.vercel.app/"
          echo "ğŸ“Š Build size: $(du -sh dist/ | cut -f1)"
          echo "ğŸ“ Files: $(find dist/ -type f | wc -l)"
          echo "âœ… Ready for production deployment"

      - name: ğŸš€ Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./
          scope: ${{ secrets.VERCEL_ORG_ID }}

  # ========================================
  # POST-DEPLOYMENT VALIDATION
  # ========================================
  post-deployment-validation:
    name: âœ… Post-Deployment Validation
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [deploy-staging, deploy-production]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸŒ Validate Staging Deployment
        run: |
          echo "ğŸ” Validating staging deployment..."
          npm run test:all-envs
          echo "âœ… Staging validation complete"

      - name: ğŸ“Š Deployment Report
        run: |
          echo "ğŸ‰ Deployment Complete!"
          echo ""
          echo "ğŸ“‹ Deployment Summary:"
          echo "ğŸŸ¢ Staging: https://gjdbradford.github.io/hermes-security-production/"
          echo "ğŸŒŸ Production: https://hermes-security-production.vercel.app/"
          echo ""
          echo "âœ… All quality gates passed"
          echo "âœ… All tests passed"
          echo "âœ… Security checks passed"
          echo "âœ… Performance checks passed"
          echo "âœ… Deployments successful"
