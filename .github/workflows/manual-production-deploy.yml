name: Manual Production Deployment

# This workflow is for MANUAL production deployments to Vercel only
# It can only be triggered manually through GitHub Actions UI
# This ensures production deployments are intentional and controlled

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
      confirm_deployment:
        description: 'Type "DEPLOY" to confirm production deployment'
        required: true
        type: string

# Environment variables
env:
  NODE_VERSION: '18'
  CACHE_VERSION: v1

jobs:
  # ========================================
  # QUALITY GATES CHECK (REQUIRED FIRST)
  # ========================================
  quality-gates-check:
    name: ğŸ” Quality Gates Check
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ” Quick Quality Gates Check
        run: |
          echo "ğŸ” Running essential quality gates for production deployment..."

          # TypeScript check
          echo "ğŸ“ TypeScript type check..."
          npx tsc --noEmit

          # Lint check
          echo "ğŸ” ESLint check..."
          npm run lint

          # Build check
          echo "ğŸ—ï¸ Production build check..."
          npm run build:production

          # Basic validation
          echo "âœ… Basic validation..."
          if [ ! -f "dist/index.html" ]; then
            echo "âŒ Production build failed - index.html missing"
            exit 1
          fi

          echo "âœ… All essential quality gates passed"

  # ========================================
  # MANUAL PRODUCTION DEPLOYMENT
  # ========================================
  manual-production-deploy:
    name: ğŸš€ Manual Production Deployment
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: quality-gates-check

    # Only run if user confirms with "DEPLOY" AND quality gates pass
    if: |
      github.event.inputs.confirm_deployment == 'DEPLOY' &&
      needs.quality-gates-check.result == 'success'

    environment:
      name: production
      url: https://hermes-security-production.vercel.app/

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build for Production
        run: npm run build:production

      - name: ğŸ” Production Build Validation
        run: |
          echo "ğŸ” Validating production build..."

          # Check critical files exist
          if [ -f "dist/index.html" ]; then
            echo "âœ… index.html found"
          else
            echo "âŒ index.html missing"
            exit 1
          fi

          if [ -f "dist/favicon.ico" ]; then
            echo "âœ… favicon.ico found"
          else
            echo "âŒ favicon.ico missing"
            exit 1
          fi

          echo "âœ… Production build validation complete"

      - name: ğŸ“Š Production Build Summary
        run: |
          echo "ğŸš€ Production Build Summary:"
          echo "ğŸ“Š Build size: $(du -sh dist/ | cut -f1)"
          echo "ğŸ“ Files: $(find dist/ -type f | wc -l)"
          echo "âœ… Ready for production deployment"

      - name: ğŸš€ Deploy to Vercel (Manual)
        run: |
          echo "ğŸš€ Manual Production Deployment to Vercel"
          echo "ğŸ“ This deployment is triggered manually by: ${{ github.actor }}"
          echo "ğŸ“ Deployment environment: ${{ github.event.inputs.environment }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo ""
          echo "âš ï¸  IMPORTANT: This is a PRODUCTION deployment"
          echo "âš ï¸  Make sure all quality gates have passed in staging first"
          echo ""
          echo "âœ… Production deployment initiated"
          echo "ğŸ“‹ Vercel will handle the actual deployment process"
          echo "ğŸŒ Production URL: https://hermes-security-production.vercel.app/"

      - name: ğŸ“‹ Manual Deployment Report
        run: |
          echo "ğŸ‰ Manual Production Deployment Complete!"
          echo ""
          echo "ğŸ“‹ Deployment Details:"
          echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
          echo "ğŸŒ Environment: ${{ github.event.inputs.environment }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸŒ Production URL: https://hermes-security-production.vercel.app/"
          echo ""
          echo "âœ… Manual production deployment successful"
          echo "ğŸ“ Vercel will complete the deployment process"

  # ========================================
  # DEPLOYMENT FAILURE NOTIFICATION
  # ========================================
  deployment-failure:
    name: âŒ Manual Deployment Failed
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [quality-gates-check, manual-production-deploy]
    if: |
      always() &&
      (needs.quality-gates-check.result == 'failure' ||
       (needs.manual-production-deploy.result == 'failure' && needs.quality-gates-check.result == 'success'))

    steps:
      - name: ğŸ“‹ Manual Deployment Failure Report
        run: |
          echo "âŒ MANUAL PRODUCTION DEPLOYMENT FAILED"
          echo ""
          echo "ğŸ“‹ Deployment Results:"
          echo "ğŸ” Quality Gates Check: ${{ needs.quality-gates-check.result }}"
          echo "ğŸš€ Manual Production Deploy: ${{ needs.manual-production-deploy.result }}"
          echo ""
          if [ "${{ needs.quality-gates-check.result }}" = "failure" ]; then
            echo "âš ï¸  QUALITY GATES FAILED:"
            echo "1. Fix the failing quality gates locally"
            echo "2. Test your changes thoroughly"
            echo "3. Try the manual deployment again"
            echo ""
            echo "ğŸš« Production deployment blocked due to quality gate failures"
          else
            echo "âš ï¸  DEPLOYMENT PROCESS FAILED:"
            echo "1. Check the deployment logs above"
            echo "2. Verify Vercel configuration"
            echo "3. Try the manual deployment again"
          fi
          echo ""
          echo "ğŸ”’ Production deployment remains secure and controlled"
